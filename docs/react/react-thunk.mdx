---
sidebar_position: 3
---


import CodeBlock from '@theme/CodeBlock';

# Lesson 3: Redux Thunk
  
```console
npm install @reduxjs/toolkit
```
  
Redux Thunk is **middleware** (syntactic sugar / abstraction) that support redux async action to be handled and dispatched.

> <img src="https://redux.js.org/assets/images/ReduxAsyncDataFlowDiagram-d97ff38a0f4da0f327163170ccc13e80.gif" width="350"/>
>
> From [Async Logic and Data Fetching in Redux official site](https://redux.js.org/tutorials/fundamentals/part-6-async-logic)

It contains only 14 lines of code. However we won't use it directly.

Instead we will use Redux Toolkit, which have already integrated redux thunk.

### Step by Step Guide 

#### 1. Define async action

```jsx title='src/store/forex/ForexAsyncAction.js'
{/* highlight-start */}
import { createAsyncThunk } from '@reduxjs/toolkit'
{/* highlight-end */}   
import xml2js from 'xml2js'
import axios from 'axios'

const xmlParser = new xml2js.Parser({explicitArray : false});

{/* highlight-start */}
const forexAsync = createAsyncThunk( 'forex/started',  
async ( { } , { getState, rejectWithValue } ) => {
{/* highlight-end */}    
        const timeout = new Promise((_, reject) => setTimeout(reject, 10000)); 
        let axiosConfig = { url: 'xxxxxxxxxxxxxxx', baseURL: 'xxxxxxxxxxxxxxx',  method: "GET", };
        const response = await Promise.race([timeout, axios.request(axiosConfig)])
        if( response.status === 200)        
        {/* highlight-start */}    
            return response.data;
        {/* highlight-end */}      
        else
        {/* highlight-start */}
            return rejectWithValue ('Invalid system response.');
        {/* highlight-end */}  
});

export { forexAsync }
```

#### 2. Define reducer and state for a slice

- Async action are divided to 3 states. pending, fulfilled and rejected. 
- When an async call is made, the state will be pending, and it will dispatch an action **forexAsync.pending** and correspoonding extraReducer will be called.
- When rejectWithValue is called in step 1, it will dispatch an action  **forexAsync.rejected** and correspoonding extraReducer will be called.
- When the result is returned in step 1, it will dispatch an action  **forexAsync.fulfilled** and correspoonding extraReducer will be called.

```jsx title='src/store/forex/index.js'
import { createSlice } from '@reduxjs/toolkit'
import { forexAsync }  from './ForexAsyncAction'

const emptyForex = {};
const initialState = emptyForex 

const forexSlice = createSlice({
  name: 'forex',
  initialState,
  reducers: {
    reset(state, action) {
      state.isLoading = false
      state.HKD = emptyForex
    },
    logout(state, action) {
      state.isLoading = false
      state.HKD = emptyForex
    }
  },
  extraReducers: {
    {/* highlight-start */}   
    [forexAsync.pending]: (state, action) => {
    {/* highlight-end */}       
      state.isLoading = true
    },
    {/* highlight-start */}       
    [forexAsync.fulfilled]: (state, action) => {
    {/* highlight-end */}           
      state.isLoading = false
      state.HKD = action.payload
    },
    {/* highlight-start */}   
    [forexAsync.rejected]: (state, action) => {
    {/* highlight-end */}   
      state.isLoading = false
      if(action.payload){
        state.errorMessage = action.payload;
      }
      else{
        state.errorMessage = action.error.message;
      }
    }
  }
})

export { forexSlice, forexAsync }
```

#### 3. Aggregate slices in Redux store

```jsx title='src/store/index.js'
import { configureStore } from '@reduxjs/toolkit'
import { localeSlice } from './locale'
{/* highlight-start */}  
import { forexSlice } from './forex'
{/* highlight-end */} 

const store = configureStore({
  reducer: {
    locale: localeSlice.reducer,
    {/* highlight-start */}  
    forex: forexSlice.reducer,
    {/* highlight-end */} 
  },
  devTools: false,
  enhancers: null,
})

export { store };
```

#### 4. Dispatch action within another action
It can be trigger by UI event. 
But in this case, the action is dispatched within another action
```jsx title='src/store/login/Login2AsyncAction.js'
{/* highlight-start */}
import { forexAsync }  from '../forex'
{/* highlight-end */}

const login2Async = createAsyncThunk( 'login/login2',  
    async ( { username, password, loginSecurityCode } , { getState, dispatch, rejectWithValue } ) => {
    
    ...
    {/* highlight-start */}
    dispatch(forexAsync({}))
    {/* highlight-end */} 
    ...

});
```       

#### 5. Detect state change and rerender UI
```jsx title='src/store/portofolio/PortfolioSummary.js'
{/* highlight-start */}
import { useSelector } from 'react-redux'
{/* highlight-end */}

const PortfolioSummary = React.forwardRef(({ marketFilter}, ref) => {
  {/* highlight-start */}
  const forex = useSelector(state => state.forex);
  {/* highlight-end */} 

  return(
    <>
    ...
    </>
  );
});
```

### Reference

- [Official Site](https://github.com/reduxjs/redux-thunk)
- [Writing Logic with Thunks](https://redux.js.org/usage/writing-logic-thunks)